image: python:3.7

before_script:
  - echo "Before script!"

stages:
  - create-binary
  - upload-to-s3

variables:
  REPO_NAME: git.apps.hexmos.com:5050/hexmos/commons/one-installer/main
  TAG_LATEST: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME:latest
  TAG_COMMIT: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME:$CI_COMMIT_SHORT_SHA

create-binary:
  # variables:
  #   CI_DEBUG_TRACE: "true"
  #   # enable verbose git output
  #   GIT_PUSH_FLAGS: "-vvv"
  #   # enable verbose ssh output
  #   GIT_SSH_COMMAND: "ssh -vvv"
  tags:
    - fw01
  stage: create-binary
  only:
    - main
  image: docker:20.10.16
  services:
    - name: docker:20.10.16
  script:
    - echo "Performing direct binary execution"
    - time docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    # Run the Docker container to extract executor.bin and save it as an artifact
    - time docker build -t $TAG_COMMIT -t $TAG_LATEST .
    - time docker run --name one-installer -d -it $REPO_NAME
    - time docker cp  one-installer:/code/executor.bin executor.bin 
  artifacts:
    paths:
      - executor.bin

upload-to-s3:
  image:
    name: amazon/aws-cli
    entrypoint: [""]
  stage: upload-to-s3
  script:
    - aws --version
    - aws s3 cp executor.bin s3://$AWS_S3_BUCKET/executor.bin
  only:
    - main